<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urdu Trigram Story Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a0a00;
            --parchment: #f5eed8;
            --parchment-dark: #e8dfc0;
            --gold: #c8922a;
            --gold-light: #e8b84b;
            --crimson: #8b1a1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Amiri', serif;
            background: var(--ink);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .page {
            max-width: 820px;
            margin: 0 auto;
            background: var(--parchment);
            border-radius: 2px;
            box-shadow:
                0 0 0 1px rgba(200,146,42,0.3),
                0 0 0 4px rgba(26,10,0,0.6),
                0 0 0 5px rgba(200,146,42,0.2),
                0 30px 80px rgba(0,0,0,0.7);
            overflow: hidden;
        }

        .header {
            background: var(--ink);
            padding: 36px 40px 28px;
            text-align: center;
            border-bottom: 3px solid var(--gold);
        }

        .header h1 {
            font-family: 'Cinzel Decorative', serif;
            color: var(--gold-light);
            font-size: 22px;
            letter-spacing: 2px;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(200,146,42,0.4);
        }

        .header p {
            color: rgba(245,238,216,0.55);
            font-size: 13px;
            margin-top: 8px;
            font-style: italic;
        }

        .header-ornament {
            color: var(--gold-light);
            font-size: 18px;
            margin-top: 14px;
            letter-spacing: 12px;
            opacity: 0.7;
        }

        .content { padding: 40px; }

        .ornament {
            text-align: center;
            color: var(--gold);
            font-size: 20px;
            margin: 4px 0 24px;
            letter-spacing: 8px;
            opacity: 0.5;
        }

        .form-group { margin-bottom: 24px; }

        label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--crimson);
            font-size: 15px;
        }

        label span {
            font-weight: 400;
            color: #7a5c3a;
            font-size: 13px;
            font-style: italic;
        }

        textarea, input[type="number"] {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--gold);
            border-radius: 1px;
            font-size: 20px;
            font-family: 'Amiri', serif;
            background: rgba(245,238,216,0.6);
            color: var(--ink);
            transition: all 0.3s;
            direction: rtl;
            text-align: right;
            outline: none;
            box-shadow: inset 0 2px 6px rgba(26,10,0,0.06);
        }

        input[type="number"] {
            direction: ltr;
            text-align: left;
            font-size: 15px;
            width: 140px;
        }

        textarea:focus, input:focus {
            border-color: var(--crimson);
            background: rgba(245,238,216,0.9);
            box-shadow: inset 0 2px 6px rgba(26,10,0,0.06), 0 0 0 3px rgba(139,26,26,0.08);
        }

        textarea { resize: vertical; min-height: 90px; }

        .divider {
            height: 1px;
            background: linear-gradient(to right, transparent, var(--gold), transparent);
            margin: 8px 0 28px;
            opacity: 0.5;
        }

        .buttons {
            display: flex;
            gap: 14px;
            margin-top: 8px;
        }

        button {
            padding: 13px 28px;
            border: none;
            border-radius: 1px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
            letter-spacing: 1.5px;
            font-family: 'Cinzel Decorative', serif;
        }

        .btn-primary {
            background: var(--ink);
            color: var(--gold-light);
            border: 1px solid var(--gold);
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 4px 20px rgba(200,146,42,0.25);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: #7a5c3a;
            border: 1px solid #c8a96a;
            font-size: 11px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(200,146,42,0.08);
            color: var(--ink);
        }

        button:disabled { opacity: 0.35; cursor: not-allowed; }

        .output-section {
            margin-top: 36px;
            padding-top: 36px;
            border-top: 1px solid rgba(200,146,42,0.3);
        }

        .status-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 14px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            font-family: 'Cinzel Decorative', serif;
        }

        .status-idle      { color: #9a8060; border: 1px solid #c8a96a; }
        .status-loading   { color: var(--gold); border: 1px solid var(--gold); background: rgba(200,146,42,0.08); }
        .status-streaming { color: #2d6a2d; border: 1px solid #4a8a4a; background: rgba(26,90,26,0.06); }
        .status-error     { color: var(--crimson); border: 1px solid var(--crimson); background: rgba(139,26,26,0.06); }

        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-streaming .status-dot { animation: pulse 1.2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.4; transform: scale(0.7); }
        }

        .manuscript {
            background: linear-gradient(160deg, var(--parchment) 0%, var(--parchment-dark) 100%);
            border: 1px solid rgba(200,146,42,0.4);
            box-shadow: inset 0 0 40px rgba(26,10,0,0.04), 0 4px 20px rgba(26,10,0,0.08);
            padding: 40px 44px;
            min-height: 280px;
            position: relative;
            direction: rtl;
        }

        .manuscript::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: repeating-linear-gradient(
                to bottom,
                transparent,
                transparent 39px,
                rgba(200,146,42,0.1) 39px,
                rgba(200,146,42,0.1) 40px
            );
            pointer-events: none;
        }

        .story-title {
            text-align: center;
            font-family: 'Amiri', serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--crimson);
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            direction: rtl;
        }

        .title-ornament {
            text-align: center;
            color: var(--gold);
            font-size: 14px;
            margin-bottom: 22px;
            letter-spacing: 8px;
            opacity: 0.6;
            position: relative;
        }

        .story-text {
            font-size: 22px;
            line-height: 2;
            color: var(--ink);
            position: relative;
            z-index: 1;
            text-align: justify;
        }

        .placeholder {
            color: #b0967a;
            font-style: italic;
            text-align: center;
            direction: ltr;
            font-size: 14px;
            padding: 60px 0;
            letter-spacing: 0.5px;
        }

        .cursor {
            display: inline-block;
            width: 2px; height: 22px;
            background: var(--crimson);
            margin-right: 4px;
            animation: blink 0.9s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 48%   { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        .debug {
            margin-top: 24px;
            border: 1px solid rgba(200,146,42,0.2);
        }

        .debug summary {
            cursor: pointer;
            font-weight: 700;
            color: #9a8060;
            padding: 10px 16px;
            font-size: 12px;
            letter-spacing: 0.5px;
            list-style: none;
        }

        .stats {
            display: flex;
            gap: 24px;
            padding: 8px 16px 0;
            font-size: 12px;
            color: #9a8060;
        }

        .debug pre {
            padding: 16px;
            background: rgba(26,10,0,0.03);
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 13px;
            color: #5a4a30;
            border-top: 1px solid rgba(200,146,42,0.15);
            direction: rtl;
            text-align: right;
        }

        .api-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #4a8a4a;
            font-style: italic;
            margin-bottom: 16px;
            direction: ltr;
        }

        .api-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: #4a8a4a;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
<div class="page">
    <div class="header">
        <h1>Urdu Trigram Story Generator</h1>
        <p>Trigram Language Model with Interpolation &middot; Phase III &amp; IV</p>
        <div class="header-ornament">&#10087; &#10022; &#10087;</div>
    </div>

    <div class="content">
        <div class="ornament">&#10022; &#10022; &#10022;</div>

        <form id="generateForm">
            <div class="form-group">
                <label for="prefix">
                    Starting Phrase (Urdu)
                    <span>&mdash; &#1705;&#1605; &#1575;&#1586; &#1705;&#1605; &#1583;&#1608; &#1575;&#1604;&#1601;&#1575;&#1592; &#1583;&#1585;&#1580; &#1705;&#1585;&#1610;&#1722;</span>
                </label>
                <textarea id="prefix" placeholder="&#1605;&#1579;&#1575;&#1604;: &#1575;&#1740;&#1705; &#1583;&#1601;&#1593;&#1729; &#1705;&#1740; &#1576;&#1575;&#1578;" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="maxTokens">
                    Maximum Tokens
                    <span>(10&ndash;300)</span>
                </label>
                <input type="number" id="maxTokens" value="80" min="10" max="300">
            </div>

            <div class="divider"></div>

            <div class="buttons">
                <button type="submit"  class="btn-primary"   id="generateBtn">&#10022; Generate Story</button>
                <button type="button"  class="btn-secondary" id="stepBtn">&#9197; Step</button>
                <button type="button"  class="btn-secondary" id="stopBtn">&#9209; Stop</button>
            </div>
        </form>

        <div class="output-section">
            <div class="status-row">
                <span class="status-badge status-idle" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Ready</span>
                </span>
            </div>

            <div class="manuscript">
                <div class="api-indicator" id="apiIndicator">
                    <span class="api-dot"></span> Backend Connected
                </div>
                <div id="titleOutput"></div>
                <div id="titleOrnament"></div>
                <div id="storyOutput" class="placeholder">&#1570;&#1662; &#1705;&#1740; &#1705;&#1729;&#1575;&#1606;&#1740; &#1740;&#1729;&#1575;&#1722; &#1592;&#1575;&#1729;&#1585; &#1729;&#1608;&#1711;&#1740;&#8230;</div>
            </div>

            <details class="debug">
                <summary>&#128202; Debug Info</summary>
                <div class="stats">
                    <div>Total Words: <strong id="totalWords">0</strong></div>
                    <div>Visible: <strong id="visibleWords">0</strong></div>
                    <div>Speed: <strong>80ms/word</strong></div>
                </div>
                <pre id="rawOutput">No output yet</pre>
            </details>
        </div>
    </div>
</div>

<script>
    const API_URL      = 'http://127.0.0.1:8001/generate';
    const STREAM_DELAY = 80;

    let allWords      = [];
    let visibleCount  = 0;
    let streamInterval = null;
    let currentStatus  = 'idle';
    let storyTitle     = '';

    const el = {
        form:          document.getElementById('generateForm'),
        prefix:        document.getElementById('prefix'),
        maxTokens:     document.getElementById('maxTokens'),
        generateBtn:   document.getElementById('generateBtn'),
        stepBtn:       document.getElementById('stepBtn'),
        stopBtn:       document.getElementById('stopBtn'),
        statusBadge:   document.getElementById('statusBadge'),
        statusText:    document.getElementById('statusText'),
        storyOutput:   document.getElementById('storyOutput'),
        titleOutput:   document.getElementById('titleOutput'),
        titleOrnament: document.getElementById('titleOrnament'),
        totalWords:    document.getElementById('totalWords'),
        visibleWords:  document.getElementById('visibleWords'),
        rawOutput:     document.getElementById('rawOutput'),
        apiIndicator:  document.getElementById('apiIndicator'),
    };

    /*
     * Title derivation — purely from the generated text, no external API.
     *
     * Strategy: pick the first 3–4 content words that appear AFTER the user's
     * prefix. Common short filler words are skipped so the title is meaningful.
     */
    function deriveTitle(prefixWords, allGeneratedWords) {
        const newWords = allGeneratedWords.slice(prefixWords.length);
        const filler = new Set([
            'کی','کا','کے','ہے','ہیں','تھا','تھی','تھے','اور','میں','نے',
            'کو','پر','سے','یہ','وہ','ایک','بھی','تو','ہی','مجھے','آپ','ہم'
        ]);
        const content = newWords.filter(w => w.length > 2 && !filler.has(w));
        const pick    = content.slice(0, 4);
        if (pick.length === 0) return prefixWords.slice(0, 3).join(' ');
        return pick.join(' ');
    }

    function setStatus(status, label) {
        currentStatus = status;
        el.statusBadge.className = 'status-badge status-' + status;
        const labels = { idle:'Ready', loading:'Generating\u2026', streaming:'Streaming\u2026', error:'Error' };
        el.statusText.textContent = label || labels[status] || status;
        updateButtons();
    }

    function updateButtons() {
        const busy = currentStatus === 'loading' || currentStatus === 'streaming';
        el.generateBtn.disabled = busy;
        el.stepBtn.disabled     = visibleCount >= allWords.length || allWords.length === 0;
        el.stopBtn.disabled     = currentStatus !== 'streaming';
    }

    function stopStreaming() {
        if (streamInterval) { clearInterval(streamInterval); streamInterval = null; }
        if (currentStatus === 'streaming') setStatus('idle');
    }

    function renderTitle() {
        if (storyTitle) {
            el.titleOutput.className     = 'story-title';
            el.titleOutput.textContent   = storyTitle;
            el.titleOrnament.className   = 'title-ornament';
            el.titleOrnament.textContent = '\uFF0A  \uFF0A  \uFF0A';
        } else {
            el.titleOutput.textContent   = '';
            el.titleOrnament.textContent = '';
            el.titleOutput.className     = '';
            el.titleOrnament.className   = '';
        }
    }

    function updateDisplay() {
        renderTitle();
        const visible = allWords.slice(0, visibleCount).join(' ');

        if (visibleCount === 0 && currentStatus !== 'streaming') {
            el.storyOutput.className = 'placeholder';
            el.storyOutput.innerHTML = '\u0622\u067E \u06A9\u06CC \u06A9\u06C1\u0627\u0646\u06CC \u06CC\u06C1\u0627\u06BA \u0638\u0627\u06C1\u0631 \u06C1\u0648\u06AF\u06CC\u2026';
        } else {
            el.storyOutput.className   = 'story-text';
            el.storyOutput.textContent = visible;

            if (currentStatus === 'streaming') {
                const c = document.createElement('span');
                c.className = 'cursor';
                el.storyOutput.appendChild(c);
            }
        }

        el.visibleWords.textContent = visibleCount;
        el.totalWords.textContent   = allWords.length;
        updateButtons();
    }

    function startStreaming() {
        setStatus('streaming');
        streamInterval = setInterval(() => {
            if (visibleCount < allWords.length) {
                visibleCount++;
                updateDisplay();
            } else {
                stopStreaming();
                updateDisplay();
            }
        }, STREAM_DELAY);
    }

    async function generateStory(e) {
        e.preventDefault();

        const prefix    = el.prefix.value.trim();
        const maxTokens = parseInt(el.maxTokens.value);

        if (!prefix) {
            alert('\u0628\u0631\u0627\u06C1 \u06A9\u0631\u0645 \u0627\u0628\u062A\u062F\u0627\u0626\u06CC \u062C\u0645\u0644\u06C1 \u062F\u0631\u062C \u06A9\u0631\u06CC\u06BA');
            return;
        }

        stopStreaming();
        allWords     = [];
        storyTitle   = '';
        visibleCount = 0;
        el.titleOutput.textContent   = '';
        el.titleOrnament.textContent = '';
        updateDisplay();
        setStatus('loading');

        try {
            const response = await fetch(API_URL, {
                method:  'POST',
                headers: { 'Content-Type': 'application/json' },
                body:    JSON.stringify({ prefix, max_tokens: maxTokens })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.detail || 'API request failed');
            }

            const data = await response.json();
            const text = data.generated_text || '';

            el.rawOutput.textContent = text;
            allWords = text.trim().split(/\s+/).filter(Boolean);

            // Derive title from generated words — no external API needed
            const prefixWords = prefix.trim().split(/\s+/);
            storyTitle = deriveTitle(prefixWords, allWords);

            el.apiIndicator.style.display = 'flex';
            startStreaming();

        } catch (err) {
            console.error(err);
            setStatus('error');
            el.storyOutput.className   = 'placeholder';
            el.storyOutput.textContent =
                '\u274C \u062E\u0637\u0627: ' + err.message +
                '\n\nMake sure the backend is running:\npython phase4_microservice.py';
            el.rawOutput.textContent = 'Error: ' + err.message;
        }
    }

    function stepForward() {
        if (visibleCount < allWords.length) { visibleCount++; updateDisplay(); }
    }

    el.form.addEventListener('submit', generateStory);
    el.stepBtn.addEventListener('click', stepForward);
    el.stopBtn.addEventListener('click', stopStreaming);

    updateButtons();

    // Health check on load
    fetch('http://127.0.0.1:8001/health')
        .then(r => r.json())
        .then(() => { el.apiIndicator.style.display = 'flex'; })
        .catch(() => {});
</script>
</body>
</html>